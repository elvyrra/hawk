#!/usr/bin/php

<?php
define('THEMES_DIR', __DIR__ . '/../themes/');
define('DEFAULT_THEME_NAME', 'hawk');

$parameters = array(
    'name' => array(
        'question' => 'What is the name of the theme (authorized caracters : alphanumeric, "-", "_") :',
        'regex' => '/^[\w\-]+$/'
    ),

    'title' => array(
        'question' => 'Give a short title to the plugin :',
        'regex' => '/^.+$/'
    ),

    'version' => array(
        'question' => 'Version (default : 1.0.0) :',
        'regex' => '/^((\d+\.){2,3}\d+)?$/'
    ),

    'author' => array(
        'question' => 'Author :',
        'regex' => '/^.*$/'        
    ),

    'extends' => array(
    	'question' => 'This theme inherit from (default \'hawk\'):',
    	'regex' => '/^[\w\-]*$/'
    )
);

$data = array();
foreach($parameters as $param => $options){
    // Get the plugin name
    do{
        echo $options['question'];
        $data[$param] = trim(fgets(STDIN));
        if($param == 'name' && is_dir(THEMES_DIR . $data[$param])) {
            echo "\033[0;31mThis theme name already exists, please choose another name\n\033[0m";
            $data[$param] = '';
        }
        elseif($param == 'extends'){
        	if($data[$param] && !is_dir(THEMES_DIR . $data[$param])){
        		echo "\033[0;31mThe theme you've mentionned as parent theme does not exists, please type an existing theme (or no theme)\n\033[0m";
        		$data[$param] = ' ';
        	}
        	elseif(!$data[$param]){
        		$data[$param] = DEFAULT_THEME_NAME;
        	}
        }
    }
    while(!preg_match($options['regex'], $data[$param]));
}

$dir = THEMES_DIR . $data['name'] ;

// make theme structure
`mkdir $dir`;
`mkdir $dir/views`;

// Copy the file theme.css from the parent theme
shell_exec('cp ' . THEMES_DIR . $data['extends'] . '/theme.css ' . THEMES_DIR . $data['name']);

// Copy the file preview.png from the parent theme
shell_exec('cp ' . THEMES_DIR . $data['extends'] . '/preview.png ' . THEMES_DIR . $data['name']);


// Create the file 'manifest.json'
$conf = array(
    'title' => $data['title'],
    'version' => $data['version'] ? $data['version'] : '1.0.0',
    'author' => $data['author'],
    'extends' => $data['extends']
);

file_put_contents($dir . '/manifest.json', json_encode($conf, JSON_PRETTY_PRINT));

// Clear view cache 
shell_exec(__DIR__ . '/clear-cache');

echo 'Theme ' , $data['name'] . ' successfully created'  , PHP_EOL;